<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guide â€” GameBrain</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* Rendu Markdown */
    .guide-body { line-height: 1.9; color: var(--text-primary); }
    .guide-body h2 { font-size: 1.4rem; color: var(--accent); margin: var(--gap-xl) 0 var(--gap-md); border-bottom: 1px solid var(--border); padding-bottom: var(--gap-sm); }
    .guide-body h3 { font-size: 1.1rem; color: var(--text-primary); margin: var(--gap-lg) 0 var(--gap-sm); }
    .guide-body p  { margin-bottom: var(--gap-md); }
    .guide-body ul, .guide-body ol { padding-left: 24px; margin-bottom: var(--gap-md); }
    .guide-body li { margin-bottom: 6px; }
    .guide-body code { font-family: var(--font-mono); background: var(--bg-input); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; color: var(--neon-green); }
    .guide-body blockquote { border-left: 3px solid var(--accent); padding-left: var(--gap-md); color: var(--text-secondary); margin: var(--gap-md) 0; }
    .guide-body hr { border: none; border-top: 1px solid var(--border); margin: var(--gap-xl) 0; }
    .guide-body strong { color: var(--text-primary); font-weight: 700; }
    .guide-body em { color: var(--text-secondary); font-style: italic; }
    .guide-body a { color: var(--accent); text-decoration: underline; text-underline-offset: 3px; transition: opacity 0.15s; }
    .guide-body a:hover { opacity: 0.75; }
    .yt-wrapper {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 */
      margin: var(--gap-xl) 0;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid var(--border);
      background: #000;
    }
    .yt-wrapper iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Layout */
    .guide-layout {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: var(--gap-xl);
      align-items: start;
    }

    .guide-sidebar {
      position: sticky;
      top: 80px;
      display: flex;
      flex-direction: column;
      gap: var(--gap-md);
    }

    .sidebar-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--gap-lg);
    }

    .sidebar-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: var(--gap-md);
    }

    /* Bandeau auteur */
    .author-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--gap-md);
      flex-wrap: wrap;
      padding: var(--gap-md) var(--gap-xl);
      background: rgba(0, 200, 255, 0.04);
      border-bottom: 1px solid var(--border-accent);
    }

    .author-bar-label {
      font-size: 0.8rem;
      color: var(--accent);
      font-weight: 600;
    }

    .author-bar-actions {
      display: flex;
      gap: var(--gap-sm);
    }

    /* Modal Ã©dition */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: var(--gap-lg);
    }

    .modal-overlay.open { display: flex; }

    .modal-box {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--gap-xl);
      width: 100%;
      max-width: 680px;
      max-height: 90vh;
      overflow-y: auto;
      animation: fadeIn 0.2s ease;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--gap-xl);
    }

    .modal-title { font-size: 1.2rem; }

    .btn-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.4rem;
      cursor: pointer;
      line-height: 1;
      padding: 4px;
      transition: color var(--transition-fast);
    }
    .btn-close:hover { color: var(--text-primary); }

    /* Modal suppression */
    .modal-delete .modal-box {
      max-width: 420px;
      text-align: center;
    }

    .delete-icon { font-size: 2.5rem; margin-bottom: var(--gap-md); }
    .delete-title { font-size: 1.1rem; font-weight: 700; margin-bottom: var(--gap-sm); }
    .delete-msg { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: var(--gap-xl); }

    .editor-toolbar {
      display: flex;
      gap: 4px;
      padding: 8px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      flex-wrap: wrap;
    }

    .editor-btn {
      padding: 4px 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .editor-btn:hover { color: var(--accent); border-color: var(--border-accent); }

    .edit-textarea {
      border-radius: 0 0 var(--radius-md) var(--radius-md) !important;
      font-family: var(--font-mono) !important;
      min-height: 280px;
    }

    @media (max-width: 768px) {
      .guide-layout { grid-template-columns: 1fr; }
      .guide-sidebar { position: static; }
    }
  </style>
</head>
<body>

  <!-- ==============================
       ğŸ§­ NAVIGATION
       ============================== -->
  <nav class="navbar" id="navbar">
    <div class="nav-inner">
      <a href="index.html" class="nav-logo">
        <span class="logo-icon">ğŸ§ </span>
        <span class="logo-text">GameBrain</span>
      </a>
      <ul class="nav-links" id="nav-links">
        <li><a href="index.html">Accueil</a></li>
        <li><a href="search.html">ğŸ” Recherche</a></li>
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="create-guide.html">âœ CrÃ©er un guide</a></li>
        <li><a href="profile.html">ğŸ‘¤ Profil</a></li>
      </ul>
      <div class="nav-actions" id="nav-actions">
        <a href="login.html" class="btn btn-ghost btn-sm">Connexion</a>
        <a href="register.html" class="btn btn-primary btn-sm">S'inscrire</a>
      </div>
      <div class="nav-user" id="nav-user">
        <span class="nav-username" id="nav-username">Joueur</span>
        <div class="nav-avatar" id="nav-avatar">ğŸ‘¤</div>
        <button class="btn btn-ghost btn-sm" id="btn-logout-nav">Quitter</button>
      </div>
      <button class="nav-toggle" id="nav-toggle"><span></span><span></span><span></span></button>
    </div>
  </nav>
  <div class="nav-overlay" id="nav-overlay"></div>

  <div class="page-wrapper">
    <div class="container">

      <!-- Fil d'Ariane -->
      <nav style="padding: var(--gap-lg) 0; font-size:0.85rem; color:var(--text-muted);">
        <a href="index.html" style="color:var(--text-muted);">Accueil</a>
        <span style="margin:0 8px;">â€º</span>
        <a href="#" id="breadcrumb-game" style="color:var(--text-muted);">Jeu</a>
        <span style="margin:0 8px;">â€º</span>
        <span style="color:var(--text-secondary);" id="breadcrumb-title">Guide</span>
      </nav>

      <div class="guide-layout">

        <!-- ==============================
             ğŸ“– ARTICLE PRINCIPAL
             ============================== -->
        <article>
          <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg); overflow:hidden;">

            <!-- Bandeau auteur (visible uniquement si c'est ton guide) -->
            <div class="author-bar" id="author-bar" style="display:none;">
              <span class="author-bar-label">âœï¸ Tu es l'auteur de ce guide</span>
              <div class="author-bar-actions">
                <button class="btn btn-secondary btn-sm" onclick="openEditModal()">âœï¸ Modifier</button>
                <button class="btn btn-danger btn-sm"   onclick="openDeleteModal()">ğŸ—‘ Supprimer</button>
              </div>
            </div>

            <!-- En-tÃªte -->
            <div style="padding: var(--gap-xl); border-bottom: 1px solid var(--border);">
              <div style="display:flex; gap:var(--gap-sm); flex-wrap:wrap; margin-bottom:var(--gap-md);">
                <span class="guide-game-tag" id="guide-game-tag">Jeu</span>
                <span class="badge-verified" id="guide-verified" style="display:none;">âœ“ Auteur vÃ©rifiÃ©</span>
              </div>

              <h1 id="guide-title" style="font-size:clamp(1.4rem,3vw,2rem); margin-bottom:var(--gap-md);">
                Chargement...
              </h1>

              <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:var(--gap-sm);">
                <div style="display:flex; align-items:center; gap:var(--gap-md); font-size:0.875rem; color:var(--text-secondary);">
                  <span>ğŸ‘¤ <strong id="guide-author">Auteur</strong></span>
                  <span id="guide-date">â€“</span>
                </div>
                <div style="display:flex; gap:var(--gap-sm);">
                  <button class="btn-like" id="btn-like" onclick="handleLike()">
                    â¤ <span id="like-count">0</span>
                  </button>
                  <button class="btn-favorite" id="btn-fav" onclick="handleFavorite()" title="Favoris">â˜†</button>
                </div>
              </div>
            </div>

            <!-- Corps -->
            <div style="padding: var(--gap-xl);">
              <div class="guide-body" id="guide-body">
                <div class="skeleton-card" style="height:300px;"></div>
              </div>
            </div>

          </div>
        </article>

        <!-- ==============================
             ğŸ“Œ SIDEBAR
             ============================== -->
        <aside class="guide-sidebar">

          <div class="sidebar-card">
            <p class="sidebar-label">Actions</p>
            <div style="display:flex; flex-direction:column; gap:var(--gap-sm);">
              <button class="btn btn-primary btn-full btn-sm" id="sidebar-btn-like" onclick="handleLike()">
                â¤ Liker (<span id="sidebar-like-count">0</span>)
              </button>
              <button class="btn btn-secondary btn-full btn-sm" id="sidebar-btn-fav" onclick="handleFavorite()">
                â˜† Ajouter aux favoris
              </button>
            </div>
          </div>

          <div class="sidebar-card">
            <p class="sidebar-label">Infos</p>
            <div style="display:flex; flex-direction:column; gap:8px; font-size:0.85rem; color:var(--text-secondary);">
              <div>ğŸ® <strong id="info-game" style="color:var(--text-primary);">â€“</strong></div>
              <div>ğŸ‘¤ <strong id="info-author" style="color:var(--text-primary);">â€“</strong></div>
              <div>ğŸ“… <strong id="info-date" style="color:var(--text-primary);">â€“</strong></div>
              <div>â¤ <strong id="info-likes" style="color:var(--text-primary);">0</strong></div>
            </div>
          </div>

          <!-- Actions auteur dans la sidebar aussi -->
          <div class="sidebar-card" id="sidebar-author-card" style="display:none;">
            <p class="sidebar-label">Mon guide</p>
            <div style="display:flex; flex-direction:column; gap:var(--gap-sm);">
              <button class="btn btn-secondary btn-full btn-sm" onclick="openEditModal()">âœï¸ Modifier</button>
              <button class="btn btn-danger btn-full btn-sm"   onclick="openDeleteModal()">ğŸ—‘ Supprimer</button>
            </div>
          </div>

          <div class="sidebar-card">
            <p class="sidebar-label">Voir plus</p>
            <a href="#" id="link-more-guides" class="btn btn-outline btn-full btn-sm">
              ğŸ“š Autres guides pour ce jeu
            </a>
          </div>

        </aside>

      </div>
    </div>
  </div>

  <!-- ==============================
       âœï¸ MODAL Ã‰DITION
       ============================== -->
  <div class="modal-overlay" id="modal-edit">
    <div class="modal-box">
      <div class="modal-header">
        <h2 class="modal-title">âœï¸ Modifier le guide</h2>
        <button class="btn-close" onclick="closeEditModal()">Ã—</button>
      </div>

      <div class="form-group">
        <label class="form-label">Titre <span style="color:var(--neon-red)">*</span></label>
        <input id="edit-title" type="text" class="form-input" maxlength="100" />
      </div>

      <div class="form-group">
        <label class="form-label">Contenu <span style="color:var(--neon-red)">*</span></label>
        <div class="editor-toolbar">
          <button type="button" class="editor-btn" data-insert="**gras**">B</button>
          <button type="button" class="editor-btn" data-insert="*italique*"><i>I</i></button>
          <button type="button" class="editor-btn" data-insert="## Titre">H2</button>
          <button type="button" class="editor-btn" data-insert="### Sous-titre">H3</button>
          <button type="button" class="editor-btn" data-insert="- Ã‰lÃ©ment">â€¢ Liste</button>
          <button type="button" class="editor-btn" data-insert="`code`">Code</button>
          <button type="button" class="editor-btn" data-insert="---">â€”</button>
          <button type="button" class="editor-btn" id="btn-yt-insert" title="InsÃ©rer une vidÃ©o YouTube">â–¶ YouTube</button>
        </div>
        <textarea id="edit-content" class="form-input edit-textarea"></textarea>
      </div>

      <div style="display:flex; gap:var(--gap-md); margin-top:var(--gap-lg);">
        <button class="btn btn-primary" style="flex:1;" id="btn-save-edit" onclick="saveEdit()">
          ğŸ’¾ Sauvegarder
        </button>
        <button class="btn btn-ghost" onclick="closeEditModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- ==============================
       ğŸ—‘ MODAL SUPPRESSION
       ============================== -->
  <div class="modal-overlay modal-delete" id="modal-delete">
    <div class="modal-box">
      <div class="delete-icon">ğŸ—‘</div>
      <div class="delete-title">Supprimer ce guide ?</div>
      <p class="delete-msg">
        Cette action est <strong>irrÃ©versible</strong>. Le guide sera dÃ©finitivement supprimÃ© pour tout le monde.
      </p>
      <div style="display:flex; gap:var(--gap-md); justify-content:center;">
        <button class="btn btn-danger" style="min-width:140px;" id="btn-confirm-delete" onclick="confirmDelete()">
          ğŸ—‘ Oui, supprimer
        </button>
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Annuler</button>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <div class="footer-inner">
        <div class="footer-brand">ğŸ§  GameBrain</div>
        <p class="footer-text">Â© 2025 GameBrain</p>
      </div>
    </div>
  </footer>

  <script type="module">
    import { db, auth }  from "./js/firebase-config.js";
    import { initNavAuth, logoutUser, getCurrentUser } from "./js/auth.js";
    import {
      doc, getDoc, collection, query, where, getDocs,
      addDoc, deleteDoc, updateDoc, increment, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { showToast, showLoader, hideLoader, formatDate } from "./js/main.js";
    import { trackGuideView } from "./js/dashboard.js";

    // â”€â”€ Nav
    initNavAuth();
    document.getElementById("btn-logout-nav")?.addEventListener("click", () => logoutUser());
    const navToggle = document.getElementById("nav-toggle");
    const navLinks  = document.getElementById("nav-links");

    function openMenu() {
      navLinks?.classList.add("open");
      navToggle?.classList.add("open");
      document.getElementById("nav-overlay")?.classList.add("open");
      document.body.style.overflow = "hidden";
    }
    function closeMenu() {
      navLinks?.classList.remove("open");
      navToggle?.classList.remove("open");
      document.getElementById("nav-overlay")?.classList.remove("open");
      document.body.style.overflow = "";
    }

    navToggle?.addEventListener("click", () => {
      navLinks?.classList.contains("open") ? closeMenu() : openMenu();
    });

    navLinks?.addEventListener("click", (e) => {
      if (e.target === navLinks) closeMenu();
    });
    document.getElementById("nav-overlay")?.addEventListener("click", closeMenu);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeMenu();
    });


    // Fermer le menu en cliquant sur un lien
    document.querySelectorAll("#nav-links a").forEach(link => {
      link.addEventListener("click", () => {
        document.getElementById("nav-links").classList.remove("open");
        document.getElementById("nav-toggle").classList.remove("open");
      });
    });
    window.addEventListener("scroll", () => {
      document.getElementById("navbar")?.classList.toggle("scrolled", window.scrollY > 30);
    });

    // â”€â”€ Ã‰tat
    const params    = new URLSearchParams(window.location.search);
    const guideId   = params.get("id");
    if (!guideId) { window.location.href = "index.html"; }

    let currentGuide = null;
    let currentUser  = await getCurrentUser();
    let isFavorited  = false;
    let hasLiked     = false;
    let isAuthor     = false;

    // â”€â”€ Markdown renderer
    // Extrait l'ID YouTube depuis n'importe quel format d'URL
    function getYouTubeId(url) {
      const patterns = [
        /(?:youtube\.com\/watch\?v=)([\w-]{11})/,
        /(?:youtu\.be\/)([\w-]{11})/,
        /(?:youtube\.com\/embed\/)([\w-]{11})/,
        /(?:youtube\.com\/shorts\/)([\w-]{11})/
      ];
      for (const p of patterns) {
        const m = url.match(p);
        if (m) return m[1];
      }
      return null;
    }

    function renderMarkdown(text) {
      return text
        .replace(/^### (.+)$/gm,   "<h3>$1</h3>")
        .replace(/^## (.+)$/gm,    "<h2>$1</h2>")
        .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
        .replace(/\*(.+?)\*/g,     "<em>$1</em>")
        .replace(/`(.+?)`/g,       "<code>$1</code>")
        // VidÃ©o YouTube [youtube](url) â†’ iframe responsive
        .replace(/\[youtube\]\(([^)]+)\)/gi, (_, url) => {
          const id = getYouTubeId(url);
          if (!id) return `<p><em>Lien YouTube invalide : ${url}</em></p>`;
          return `<div class="yt-wrapper"><iframe src="https://www.youtube.com/embed/${id}" allowfullscreen loading="lazy" title="VidÃ©o YouTube"></iframe></div>`;
        })
        // Liens normaux [texte](url) â†’ <a>
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
        .replace(/^> (.+)$/gm,     "<blockquote>$1</blockquote>")
        .replace(/^- (.+)$/gm,     "<li>$1</li>")
        .replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>")
        .replace(/^---$/gm,        "<hr>")
        .replace(/\n\n/g,        "</p><p>")
        .replace(/^(?!<[h2|h3|ul|hr|bl])(.+)$/gm, "<p>$1</p>");
    }

    // â”€â”€ Chargement du guide
    async function loadGuide() {
      showLoader();
      try {
        const snap = await getDoc(doc(db, "guides", guideId));
        if (!snap.exists()) {
          showToast("Guide introuvable.", "error");
          window.location.href = "index.html";
          return;
        }

        currentGuide = { id: snap.id, ...snap.data() };

        // Jeu
        const gameSnap = await getDoc(doc(db, "games", currentGuide.gameId));
        const gameName = gameSnap.exists() ? gameSnap.data().name : "Jeu";

        // Breadcrumb
        const bcGame = document.getElementById("breadcrumb-game");
        if (bcGame) { bcGame.textContent = gameName; bcGame.href = `game.html?id=${currentGuide.gameId}`; }
        document.getElementById("breadcrumb-title").textContent = currentGuide.title;
        document.title = `${currentGuide.title} â€” GameBrain`;

        // En-tÃªte
        document.getElementById("guide-title").textContent    = currentGuide.title;
        document.getElementById("guide-game-tag").textContent = gameName;
        const authorEl = document.getElementById("guide-author");
        authorEl.textContent = currentGuide.authorName || "Anonyme";
        if (currentGuide.authorId) {
          authorEl.style.cursor = "pointer";
          authorEl.style.color  = "var(--accent)";
          authorEl.title = "Voir le profil";
          authorEl.onclick = () => window.location.href = `user.html?id=${currentGuide.authorId}`;
        }
        document.getElementById("guide-date").textContent     = formatDate(currentGuide.createdAt);
        if (currentGuide.authorVerified) document.getElementById("guide-verified").style.display = "inline-flex";

        // Likes
        const likes = currentGuide.likesCount || 0;
        document.getElementById("like-count").textContent         = likes;
        document.getElementById("sidebar-like-count").textContent = likes;
        document.getElementById("info-game").textContent          = gameName;
        document.getElementById("info-author").textContent        = currentGuide.authorName || "Anonyme";
        document.getElementById("info-date").textContent          = formatDate(currentGuide.createdAt);
        document.getElementById("info-likes").textContent         = likes;
        document.getElementById("link-more-guides").href          = `game.html?id=${currentGuide.gameId}`;

        // Contenu
        document.getElementById("guide-body").innerHTML = renderMarkdown(currentGuide.content || "");

        // Tracker dans l'historique
        trackGuideView(guideId, currentGuide.title, gameName, currentGuide.authorName);

        // â”€â”€ Est-ce que c'est l'auteur ?
        if (currentUser && currentUser.uid === currentGuide.authorId) {
          isAuthor = true;
          document.getElementById("author-bar").style.display        = "flex";
          document.getElementById("sidebar-author-card").style.display = "block";
        }

        // Favoris
        if (currentUser) {
          const favsSnap = await getDocs(query(
            collection(db, "favorites"),
            where("userId",  "==", currentUser.uid),
            where("guideId", "==", guideId)
          ));
          isFavorited = !favsSnap.empty;
          updateFavButton();
        }

      } catch (err) {
        console.error(err);
        showToast("Impossible de charger le guide.", "error");
      } finally {
        hideLoader();
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // âœï¸ Ã‰DITION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    window.openEditModal = function() {
      // PrÃ©-remplir le formulaire avec les valeurs actuelles
      document.getElementById("edit-title").value   = currentGuide.title || "";
      document.getElementById("edit-content").value = currentGuide.content || "";
      document.getElementById("modal-edit").classList.add("open");
    };

    window.closeEditModal = function() {
      document.getElementById("modal-edit").classList.remove("open");
    };

    window.saveEdit = async function() {
      const title   = document.getElementById("edit-title").value.trim();
      const content = document.getElementById("edit-content").value.trim();
      const btn     = document.getElementById("btn-save-edit");

      if (!title)              { showToast("Le titre est requis.",   "warning"); return; }
      if (content.length < 20) { showToast("Le contenu est trop court.", "warning"); return; }

      btn.disabled    = true;
      btn.textContent = "Sauvegarde...";
      showLoader();

      try {
        await updateDoc(doc(db, "guides", guideId), { title, content });

        // Mettre Ã  jour l'affichage sans recharger
        currentGuide.title   = title;
        currentGuide.content = content;
        document.getElementById("guide-title").textContent      = title;
        document.getElementById("breadcrumb-title").textContent = title;
        document.getElementById("guide-body").innerHTML         = renderMarkdown(content);
        document.title = `${title} â€” GameBrain`;

        closeEditModal();
        showToast("Guide mis Ã  jour ! âœ“", "success");
      } catch (err) {
        console.error(err);
        showToast("Erreur lors de la sauvegarde.", "error");
      } finally {
        btn.disabled    = false;
        btn.textContent = "ğŸ’¾ Sauvegarder";
        hideLoader();
      }
    };

    // Toolbar Markdown dans le modal
    document.querySelectorAll(".editor-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const textarea = document.getElementById("edit-content");

        // Bouton YouTube spÃ©cial
        if (btn.id === "btn-yt-insert") {
          const url = prompt("Colle l'URL YouTube :");
          if (!url) return;
          const snippet = `[youtube](${url.trim()})`;
          const start = textarea.selectionStart;
          textarea.value = textarea.value.substring(0, start) + "\n" + snippet + "\n" + textarea.value.substring(start);
          textarea.focus();
          return;
        }

        const snippet  = btn.dataset.insert;
        const start    = textarea.selectionStart;
        const before   = textarea.value.substring(0, start);
        const after    = textarea.value.substring(textarea.selectionEnd);
        textarea.value = `${before}${snippet}${after}`;
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = start + snippet.length;
      });
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ—‘ SUPPRESSION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    window.openDeleteModal = function() {
      document.getElementById("modal-delete").classList.add("open");
    };

    window.closeDeleteModal = function() {
      document.getElementById("modal-delete").classList.remove("open");
    };

    window.confirmDelete = async function() {
      const btn = document.getElementById("btn-confirm-delete");
      btn.disabled    = true;
      btn.textContent = "Suppression...";
      showLoader();

      try {
        // Supprimer le guide
        await deleteDoc(doc(db, "guides", guideId));

        // Nettoyer les favoris associÃ©s
        const favsSnap = await getDocs(query(
          collection(db, "favorites"),
          where("guideId", "==", guideId)
        ));
        for (const d of favsSnap.docs) {
          await deleteDoc(doc(db, "favorites", d.id));
        }

        showToast("Guide supprimÃ©.", "info");
        // Rediriger vers le jeu
        window.location.href = `game.html?id=${currentGuide.gameId}`;

      } catch (err) {
        console.error(err);
        showToast("Erreur lors de la suppression.", "error");
        btn.disabled    = false;
        btn.textContent = "ğŸ—‘ Oui, supprimer";
        hideLoader();
      }
    };

    // Fermer modals en cliquant sur l'overlay
    document.querySelectorAll(".modal-overlay").forEach(overlay => {
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) overlay.classList.remove("open");
      });
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â¤ LIKE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    window.handleLike = async function() {
      if (!currentUser) { showToast("Connecte-toi pour liker.", "warning"); return; }
      if (hasLiked)     { showToast("Tu as dÃ©jÃ  likÃ© ce guide !", "warning"); return; }

      try {
        await updateDoc(doc(db, "guides", guideId), { likesCount: increment(1) });
        hasLiked = true;
        const newCount = (currentGuide.likesCount || 0) + 1;
        currentGuide.likesCount = newCount;
        document.getElementById("like-count").textContent         = newCount;
        document.getElementById("sidebar-like-count").textContent = newCount;
        document.getElementById("info-likes").textContent         = newCount;
        document.getElementById("btn-like").classList.add("liked");
        showToast("Guide likÃ© ! â¤", "success");
      } catch { showToast("Erreur lors du like.", "error"); }
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â­ FAVORIS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    window.handleFavorite = async function() {
      if (!currentUser) { showToast("Connecte-toi pour ajouter aux favoris.", "warning"); return; }

      try {
        const favsRef = collection(db, "favorites");
        if (!isFavorited) {
          await addDoc(favsRef, { userId: currentUser.uid, guideId, createdAt: serverTimestamp() });
          isFavorited = true;
          showToast("AjoutÃ© aux favoris !", "success");
        } else {
          const snap = await getDocs(query(favsRef, where("userId", "==", currentUser.uid), where("guideId", "==", guideId)));
          for (const d of snap.docs) await deleteDoc(doc(db, "favorites", d.id));
          isFavorited = false;
          showToast("RetirÃ© des favoris.", "info");
        }
        updateFavButton();
      } catch { showToast("Erreur favoris.", "error"); }
    };

    function updateFavButton() {
      const fav1 = document.getElementById("btn-fav");
      const fav2 = document.getElementById("sidebar-btn-fav");
      if (fav1) { fav1.textContent = isFavorited ? "â˜…" : "â˜†"; fav1.classList.toggle("active", isFavorited); }
      if (fav2) { fav2.textContent = isFavorited ? "â˜… Dans mes favoris" : "â˜† Ajouter aux favoris"; }
    }

    // â”€â”€ Lancement
    loadGuide();
  </script>

</body>
</html>
